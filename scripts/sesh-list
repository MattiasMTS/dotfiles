#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-list}"

case "$cmd" in
  list)
    # tmux sessions: detect worktree sessions by directory name (repo#worktree format)
    sesh list -t --icons | while read -r line; do
      name="${line#* }"
      session_path=$(tmux display-message -t "$name" -p '#{pane_current_path}' 2>/dev/null) || session_path=""
      dir_name=$(basename "$session_path")
      if [[ -n "$session_path" && -f "$session_path/.git" && "$dir_name" == *"#"* ]]; then
        echo -e "ó°˜¬ ${dir_name}\t${session_path}"
        continue
      fi
      echo -e "${line}\t${name}"
    done

    # project folders (exclude worktrees - they have .git as file, not dir)
    for dir in ~/src/github.com/projects ~/src/github.com/lovablelabs; do
      [[ -d "$dir" ]] || continue
      for project in "$dir"/*/; do
        [[ -d "$project" ]] || continue
        project="${project%/}"
        # skip if .git is a file (worktree) rather than directory (main repo)
        [[ -f "$project/.git" ]] && continue
        echo -e " $(basename "$project")\t${project}"
      done
    done
    ;;

  connect)
    target="${2:-}"
    [[ -z "$target" ]] && exit 0

    # repo#branch -> worktree; path -> sesh; session -> sesh
    if [[ "$target" == *"#"* ]]; then
      exec git-worktree-session add "$target"
    elif [[ "$target" == /* && -d "$target" ]]; then
      exec sesh connect "$target"
    elif tmux has-session -t "$target" 2>/dev/null; then
      exec sesh connect "$target"
    else
      exec git-worktree-session add "$target"
    fi
    ;;

  delete)
    target="${2:-}"
    [[ -z "$target" ]] && exit 0

    if [[ "$target" == *"#"* ]]; then
      # worktree: git-worktree-session handles both worktree and tmux session
      git-worktree-session remove "$target" 2>/dev/null || true
    else
      # regular tmux session
      tmux kill-session -t "$target" 2>/dev/null || true
    fi
    ;;
esac
